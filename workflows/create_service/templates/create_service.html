{% extends "layout.html" %}

{% block head -%}
		{# IMPORT SELECTPICKER #}
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/vendor/bootstrap-select.min.css') }}">
		<script type="text/javascript" src="{{ url_for('static', filename='js/vendor/bootstrap-select.min.js') }}"></script>

		{# IMPORT CUSTOM STYLESHEET FOR CAROUSEL #}
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/carousel.css') }}">

		{#- CodeMirror style -#}
		<link href="{{ url_for('static', filename='css/vendor/codemirror.min.css') }}" rel="stylesheet">
		<link href="{{ url_for('static', filename='css/vendor/lint.min.css') }}" rel="stylesheet">

		{#- CodeMirror scripts -#}
		<script src="{{ url_for('static', filename='js/vendor/codemirror.min.js') }}"></script>
		<script src="{{ url_for('static', filename='js/vendor/yaml.min.js') }}"></script>
		<script src="{{ url_for('static', filename='js/vendor/lint.min.js') }}"></script>
		<script src="{{ url_for('static', filename='js/vendor/js-yaml.min.js') }}"></script>
		<script src="{{ url_for('static', filename='js/vendor/yaml-lint.js') }}"></script>
		
		{#- datetime-pickers -#}
		<link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/tempusdominus-bootstrap-4.min.css') }}">
		<script src="{{ url_for('static', filename='js/vendor/moment.js') }}"></script>
		<script src="{{ url_for('static', filename='js/vendor/tether.min.js') }}"></script>
		<script src="{{ url_for('static', filename='js/vendor/en-gb.js') }}"></script>
		<script src="{{ url_for('static', filename='js/vendor/tempusdominus-bootstrap-4.min.js') }}"></script>
		
		{#- Override CodeMirror style - must come after CodeMirror style imports -#}
		<style type="text/css">
		.CodeMirror {
			border: 1px solid #eee;
			height: auto;
		}
		</style>

{% endblock %}

{% block body %}

<div class="page-header">
	<h3><i class="fa fa-plus-circle fa-fw"></i> Create a New Service</h3>
	<p class="text-muted">This workflow will create a new service in the chosen environment. Hostnames will be automatically allocated from the 'srv' group, and will automatically have IP addresses assigned from Infoblox. ServiceNow CIs will also be created. Can build standard or sandbox services.</p>
</div>
<div id="flashedMessages">
</div>

<!--
	This is the main carousel body. The rest of the page is generated dynamically
	depending on the user input. Whatever is added here will be static.
-->
<div id="vm-carousel" class="carousel slide" data-ride="carousel" data-interval="false" data-wrap="false">
	<ol class="carousel-indicators">
		<li data-target="#vm-carousel" data-slide-to="0" class="active"></li>
	</ol>
	<form id="service_request_form" method="POST" role="form">
		<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
		<input type="hidden" id="action" name="action" value="create_recipe"/>
		<input type="hidden" id="workflow_type" name="workflow_type" value="standard"/>
		<div class="carousel-inner">
			<div class="carousel-item active">
				<img class="first-slide" src="{{url_for('static', filename='images/sky-blue-solid-color.jpg')}}" alt="First slide">
				<div class="container">
					<div class="carousel-caption" id="choose-action">
						<a id="use-existing" class="btn btn-lg btn-primary" data-target="#add-service-existing-template" data-toggle="modal">Use/Edit a service template</a>
						<hr class="hr-text" data-content="OR">
						<a id="create-service-template" class="btn btn-lg btn-success">Create a service template</a>
					<div class="carousel-caption" style="display: inline-flex; justify-content: center;">
						<h3 style="color: #777; margin-bottom:0px; margin-right: 20px; align-self: center;">Choose a workflow type:</h2>
						<div class="btn-group btn-toggle">
                                                        <button class="btn btn-lg btn-primary active" data-value="standard">Standard</button>
                                                        <button class="btn btn-lg btn-secondary" data-value="sandbox">Sandbox</button>
                                                </div>
					</div>
					</div>
				</div>
			</div>
		</div>
	<!--
		This modal contains the list of all additional quesitons
	-->
	<div class="modal fade" id="current-additional-questions" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-xl modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" >Additional Questions</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button id="save-questions-changes" type="button" class="btn btn-primary" data-dismiss="modal"><i class="fa fa-save"></i>Save</button>
				</div>
			</div>
		</div>
	</div>
	<!--
		This modal is used for adding new inputs to the form
	-->
	<div class="modal fade" id="add-form-question" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-xl modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" >Add a Form Question</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-sm-3 offset-1">Question/Input description:</div>
						<div class="col-sm-6"><input id="question-text-input" class="form-control w-100"></div>
					</div>
					<div class="row" style="margin-top: 2rem;">
						<div class="col-sm-3 offset-1">Answer:</div>
						<div class="col-sm-6"><input id="question-answer" class="form-control w-100"></div>
					</div>
					<div class="row" style="margin-top: 2rem;">
						<div class="col-sm-3 offset-1">Question Reference:</div>
						<div class="col-sm-6"><input id="question-name-value" class="form-control w-100" pattern="\w+" /></div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button id="submit-question" type="button" class="btn btn-primary">Submit Question</button>
				</div>
			</div>
		</div>
	</div>

	</form>
	<a class="carousel-control-prev" href="#vm-carousel" role="button" data-slide="prev">
		<span class="carousel-control-prev-icon" aria-hidden="true"></span>
		<span class="sr-only">Previous</span>
	</a>
	<a class="carousel-control-next" href="#vm-carousel" role="button" data-slide="next">
		<span class="carousel-control-next-icon" aria-hidden="true"></span>
		<span class="sr-only">Next</span>
	</a>
</div>

<!--
	This modal pups up when the user tries to use
	an existing service recipe
-->
<div class="modal fade" id="add-service-existing-template" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                                <h5 class="modal-title">Use Existing Service Template</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                </button>
                        </div>
                        <div class="modal-body">
				<table class="table table-condensed table-striped" id="service-recipes-table" style="width:100%;">
					<thead>
						<tr>
							<th><div class="tablesorter-inner">Name</div></th>
							<th><div class="tablesorter-inner">Description</div></th>
							<th width="100px"><div class="tablesorter-inner">Default&nbsp;Environment</div></th>
							<th width="125px">Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for name in service_recipes_details %}
						<tr>
							<td>{{ name }}</td>
							<td style="display: block; overflow: hidden; white-space: nowrap; width: 35rem; text-overflow: ellipsis;">{% if service_recipes_details[name]["description"] != None %} {{service_recipes_details[name]["description"]}} {% else %} N/A {% endif %}</td>
							<td>{{ service_recipes_details[name]["env"] }}</td>
							<td style="color: white;">
								<a class="btn btn-sm btn-danger delete-service" data-name="{{name}}" data-target="#confirm-delete-modal" data-toggle="modal"><i class="fa fa-fw fa-trash"></i></a>
								<a class="btn btn-sm btn-info" data-target="#{{ name }}-info-modal" data-toggle="modal"><i class="fa fa-fw fa-info-circle"></i></a>
								<a class="btn btn-sm btn-success submit-template-request" data-name="{{ name }}" data-dismiss="modal"><i class="fa fa-fw fa-check-circle"></i></a>
								
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
                        </div>
                        <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                </div>
        </div>
</div>


<div id="create-service-template-form">
	<!--
		This is the step where you get to give your new service template a name
	-->
	<div class="carousel-item" id="create-service-template-item">
		<img src="{{url_for('static', filename='images/dark-blue-solid-color.jpg')}}">
		<div class="carousel-item-content-center name-service">
			<div class="form-group w-25">
				<div class="input-group d-none" id="service-now-task">
                                        <h4 class="w-100" style="text-align: left;">ServiceNow Task:<span class="required">*</span></h4>
					<input class="form-control w-100" id="task" name="task" placeholder="e.g. CTASK0123456 or PRJTASK0987654" autofocus required/>
                                </div>
				<div class="input-group hide-on-use" style="margin-top: 2.5%;">
					<label for="service_name" class="h4 w-100 text-left" style="margin-bottom: 10px;">Service recipe name<span class="required">*</span></label>
					<input id="service_name" class="form-control form-control-lg" type="text" name="service_name" placeholder="service_name_example" aria-label="Service_name" value="" pattern="\w+" required>
				</div>
				<div id="service_description_input_group" class="input-group hide-on-use" style="margin-top: 2.5%;">
					<label for="servuce_description" class="h4 w-100 text-left" style="margin-bottom: 10px;">Recipe description<span class="required">*</span></label>
					<textarea class="form-control" id="service_description" name="service_description" placeholder="A general description for the service recipe" style="height: 9em;" required></textarea>
				</div>
				<div class="input-group hide-on-create" style="margin-top: 2.5%;">
					<label for="expiry" class="h4 w-100 text-left" style="margin-bottom: 10px;">Expiry date (optional)</label>
					<div class='input-group date' id='expirypicker' data-target-input="nearest">
						<input type='text' class="form-control datetimepicker-input" id="expiry" name="expiry" placeholder="YYYY-MM-DD" data-target="expirypicker" />
						<span class="input-group-append" data-target="#expirypicker" data-toggle="datetimepicker">
							<div class="input-group-text"><i class="fa fa-calendar"></i></div>
						</span>
						<div style="text-align: justify;">Set the date when all the VMs belonging to this service will be powered off.</div>

					</div>
					<!-- 
						Initialize the expiry date picker
					-->
					<script>
						$(function () {
							$('#expirypicker').datetimepicker({
								viewMode: 'days',
								format: 'YYYY-MM-DD',
								minDate: moment(),
								useCurrent: false,
								widgetPositioning: {
									horizontal: 'right',
									vertical: 'top',
								},
							});
						});
					</script>
				</div>
				<div class="input-group">
					<h4 style="margin-top:1em; text-align: left; width: 100%;">Environment<span class="required">*</span></h4>
					<div class="w-100">
						<select class="selectpicker-disabled w-100" name="env" id="env" required>
							<option></option>
							{% for environment in environments -%}
							<option value="{{ environment.id }}"{% if default_env == environment.id %} selected="selected"{% endif %}>{{ environment.name }}</option>
							{%- endfor %}
						</select>
					</div>
				</div>
				<div class="input-group hide-on-create" style="margin-top: 7.5%;">
					<div class="custom-control custom-switch">
						<input type="checkbox" class="custom-control-input" id="sendmail" name="sendmail" style="margin-right:0.4em; width: 1rem; height: 1rem; align-self: center;">
						<label class="custom-control-label h4" for="sendmail" style="position:relative; top:-2px; margin-bottom: 0px!important;">Send me an email notification</label>
					</div>
				</div>
				<div class="input-group" style="margin-top: 7.5%; justify-content: center;">
					<div class="btn-group" role="group">
						<button type="button" class="btn btn-primary" data-target="#add-form-question" data-toggle="modal">Add a form question</button>
						<button type="button" class="btn btn-success" data-target="#current-additional-questions" data-toggle="modal">View additional questions</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 
		This is the step where you get to choose the VMs that make up your service.
	-->
	<div class="carousel-item" id="add-vms-template-item">
                <img src="{{url_for('static', filename='images/sky-blue-solid-color.jpg')}}">
		<div id="vms-card-list-wrapper" class="carousel-item-content-top">
			<div class="w-100 h-100" id="vms-card-list">
			</div>
		</div>
		<div class="carousel-caption">
			<div class="btn-group" role="group" id="choose-vm-action">
				<button type="button" class="btn btn-lg btn-primary" data-target="#add-vm-existing-recipe" data-toggle="modal">Add a VM</button>
				<button type="submit" id="submit_service_request" class="btn btn-success btn-lg btn-submit">Run Task</button>
			</div>
		</div>
        </div>
</div>
<!--
	This modal is used for adding new inputs to the form

<div class="modal fade" id="add-form-question" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                                <h5 class="modal-title" >Add a Form Question</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                </button>
                        </div>
                        <div class="modal-body">
                                <div class="row">
                                        <div class="col-sm-3 offset-1">Question/Input description:</div>
                                        <div class="col-sm-6"><input id="question-text-input" class="form-control w-100"></div>
                                </div>
				<div class="row" style="margin-top: 2rem;">
                                        <div class="col-sm-3 offset-1">Answer:</div>
                                        <div class="col-sm-6"><input id="question-answer" class="form-control w-100"></div>
                                </div>
				<div class="row" style="margin-top: 2rem;">
                                        <div class="col-sm-3 offset-1">Question Reference:</div>
                                        <div class="col-sm-6"><input id="question-name-value" class="form-control w-100" pattern="\w+" /></div>
                                </div>
                        </div>
                        <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button id="submit-question" type="button" class="btn btn-primary" data-dismiss="modal">Submit question</button>
                        </div>
                </div>
        </div>
</div>
-->
<!--
	This is a row div which is used as a template when a new question is added
-->

<div class="row d-none question-row" style="margin-top: 2%;">
	<div class="col-sm-3 offset-1 question-text"></div>
	<div class="col-sm-8 question-inputs">
		<div class="input-group">
			<input type="text" class="form-control answer-input" name="" value="">
			<div class="input-group-append">
				<span class="input-group-text" style="padding: 0 0; color: white;">
					<a class="btn btn-danger delete-question" data-toggle="modal" data-target="#confirm-delete-question-modal">
						<i class="fa fa-fw fa-trash"></i>
					</a>
					<a class="btn btn-info question-info" data-toggle="modal" data-target="#question-info-modal">
						<i class="fa fa-fw fa-info-circle"></i>
					</a>
				</span>
			</div>
		</div>
		<input type="hidden" class="question-text" name="text" value="">
	</div>
</div>

<!--
	This modal contains more details about a specific question
-->
<div class="modal fade" id="question-info-modal" tabindex="-1" role="dialog" aria-hidden="true" style="text-align: justify;">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                                <h5 class="modal-title">Question Info</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                </button>
                        </div>
                        <div class="modal-body">
                                <hr class="hr-text" style="opacity: 1!important;">
                                <div class="row">
                                        <div class="col-sm-3 offset-1 h5 text" style="font-weight: bolder; margin-top: 0; margin-bottom:0;"><p>Full text:</p></div>
                                        <div class="col-sm-6 h6 text" style="margin-top: 0; margin-bottom: 0;"><p class="full-text-info"></p></div>
                                </div>
                                <hr class="hr-text" style="opacity: 1!important;" >
				<div class="row">
                                        <div class="col-sm-3 offset-1 h5 text" style="font-weight: bolder; margin-top: 0; margin-bottom:0;"><p>Answer: </p></div>
                                        <div class="col-sm-6 h6 text" style="margin-top: 0; margin-bottom: 0;"><p class="answer-info"></p></div>
                                </div>
                                <hr class="hr-text" style="opacity: 1!important;" >
                        </div>
                        <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                </div>
        </div>
</div>

<div class="modal fade" id="confirm-delete-question-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                                <h5 class="modal-title">Permanently Delete Question</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                </button>
                        </div>
                        <div class="modal-body">
                                <h5 style="text-align: center;">Are you sure you want to delete this question?</h5>
                        </div>
                        <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button id="confirm" type="button" class="btn btn-success" data-dismiss="modal">Confirm</button>
                        </div>
                </div>
        </div>
</div>

<!--
	Datalist of names of existing service recipes
-->
<datalist id="autocomplete-service-templates">
	<option></option>
	{% for name in service_recipes_details %}
		<option id="{{name}}">{{name}}</option>
	{% endfor %}
</datalist>

<!--
	This is the modal used to select one of the existing recipes by name
-->
<div class="modal fade" id="add-vm-existing-recipe" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" >Use Existing Recipe</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="row">
					<div class="col-sm-3 offset-1">Type in a recipe name</div>
					<div class="col-sm-6"><input id="vm-recipe-input" class="form-control w-100" maxlength="64" pattern="\w+"/></div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				<button type="button" class="btn btn-primary" id="new-vm-recipe">Save Changes</button>
			</div>
		</div>
	</div>
</div>
<!--
	Each service recipe which is listed in the datatable will target a modal
	which contains some more details about it
-->
{% for name in service_recipes_details %}
<div class="modal fade" id="{{name}}-info-modal" tabindex="-1" role="dialog" aria-hidden="true" style="text-align: justify;">
	<div class="modal-dialog modal-lg modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Info</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<hr class="hr-text" style="opacity: 1!important;">
				<table class="table system-overview-table">
				{% for attribute in service_recipes_details[name] %}
				<div class="row">
					<div class="col-sm-3 offset-1 h5 text" style="font-weight: bolder; margin-top: 0; margin-bottom:0;"><p>{{ attribute.upper() }}:</p></div>
					<div class="col-sm-6 h6 text" style="margin-top: 0; margin-bottom: 0;"><p>{{ service_recipes_details[name][attribute] }}</p></div>
				</div>
				<hr class="hr-text" style="opacity: 1!important;" >
				{% endfor %}
				</table>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>
{% endfor %}
<!--
	This modal will pop up when the user attempts to delete a service recipe
	The text inside the body will get replaced when the modal shows
-->
<div class="modal fade" id="confirm-delete-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                                <h5 class="modal-title">Permanently Delete a Service Recipe</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                </button>
                        </div>
                        <div class="modal-body">
				<h5 style="text-align: center;">Are you sure you want to delete this service recipe?</h5>
                        </div>
                        <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				<button id="confirm" type="button" class="btn btn-success" data-dismiss="modal">Confirm</button>
                        </div>
                </div>
        </div>
</div>
<!--
	This modal pops up when a user attempts to detelete a VM recipe
	The text inside the body will get replaced when the modal shows
-->
<div class="modal fade" id="confirm-delete-vm-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                                <h5 class="modal-title">Permanently Delete VM Recipe</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                </button>
                        </div>
                        <div class="modal-body">
                                <h5 style="text-align: center;">Are you sure you want to delete this VM recipe?</h5>
                        </div>
                        <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button id="confirm-delete-vm" type="button" class="btn btn-success" data-dismiss="modal">Confirm</button>
                        </div>
                </div>
        </div>
</div>
<!--
	This modal contains the puppet code, the VM specs and the VM recipe description, which can be edited by the user.
	Each time a new VM recipe is added, this modal will get cloned and changed a bit depending on the recipe name.
-->
<div class="modal fade" id="vm-recipe-template-modal" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title"></h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			</div>
		
			<div class="modal-body">
				<ul class="nav nav-tabs" style="margin-bottom:1em" role="tablist">
					<li class="nav-item"><a class="nav-link active" id="vm-puppet" data-toggle="tab" style="cursor:pointer" href="#puppet-code">Puppet</a></li>
					<li class="nav-item"><a class="nav-link" id="vm-configuration" data-toggle="tab" style="cursor:pointer" href="#config">Configuration</a></li>
					<li class="nav-item"><a class="nav-link" id="vm-description-tab" data-toggle="tab" style="cursor:pointer" href="#vm-description">General description</a></li>
				</ul>
				<div class="tab-content">
					<div id="puppet-code" class="tab-pane container fade active show">
						<h3>Puppet Code</h3>
						<textarea class="form-control" id="puppet_classes" name="puppet_classes" style="height: 550px;" placeholder="Classes to include can be entered here"> </textarea>
					</div>
					<div id="config" class="tab-pane container fade">
						<h3>VM Config</h3>
						
						<div class="row">
							<div class="col-md-12">
								<h4 style="margin-top:0">1. Enter request details</h4>
								<div class="form-group row col-md-12">
									<label for="purpose">Purpose:<span class="required">*</span></label><input class="form-control" id="purpose" name="purpose" placeholder="The purpose of the Virtual Machine, e.g. Corporate Website Web Server" autofocus />
								</div>
								<div class="form-group row col-md-12">
									<label for="comments">Comments:</label><input class="form-control" id="comments" name="comments" placeholder="Any other notes to store in the comments section of the CMDB" />
								</div>
								<div class="row">
									<div class="form-group col-md-3">
										<label for="primary_owner_who">Primary Owner:</label><input class="form-control" list="autocompleteUsers" autocomplete="off" id="primary_owner_who" name="primary_owner_who" placeholder="Primary owner's username" maxlength="64"/>
									</div>
									<div class="form-group col-md-3">
										<label for="primary_owner_role">Primary Owner Role:</label><input class="form-control" id="primary_owner_role" name="primary_owner_role" placeholder="Primary owner's role" maxlength="64"/>
									</div>
									<div class="form-group col-md-3">
										<label for="secondary_owner_who">Secondary Owner:</label><input class="form-control" list="autocompleteUsers" autocomplete="off" id="secondary_owner_who" name="secondary_owner_who" placeholder="Secondary owner's username" maxlength="64"/>
									</div>
									<div class="form-group col-md-3">
										<label for="secondary_owner_role">Secondary Owner Role:</label><input class="form-control" id="secondary_owner_role" name="secondary_owner_role" placeholder="Secondary owner's role" maxlength="64"/>
								</div>
								</div>
							</div>
						</div>
						<div class="row" style="margin-top: 1.6em">
							<div class="col-md-12">
								<h4>2. Customise Specification</h4>
								<div class="row">
									<div class="form-group col-md-3" style="margin-top:2.4em">
										<label for="sockets-slider">Sockets:</label> 
										<input class="slider form-control-range slider-input" type="range" id="sockets-slider" name="sockets"  step="1" min="1" max="16" value="1">
										<span class="badge badge-primary output" style="font-size: 14px;"></span>
										<p class="text-muted">Number of CPU sockets</p>
									</div>
									<div class="form-group col-md-3" style="margin-top:2.4em">
										<label for="cores-slider">Cores:</label>    
										<input class="slider form-control-range slider-input" type="range" id="cores-slider" name="cores"  step="1" min="1" max="16" value="1">
										<span class="badge badge-primary output" style="font-size: 14px;"></span> 
										<p class="text-muted">Number of cores per socket</p>
									</div>
									<div class="form-group col-md-3" style="margin-top:2.4em">
										<label for="ram-slider">RAM (GB):</label>    
										<input class="slider form-control-range slider-input" type="range" id="ram-slider" name="ram"  step="2" min="2" max="32" value="2">
										<span class="badge badge-primary output" style="font-size: 14px;"></span>
										<p class="text-muted">Total amount of RAM, including video RAM</p>
									</div>
									<div class="form-group col-md-3" style="margin-top:2.4em">
										<label for="disk-slider">Disk (GB):</label>  
										<input class="slider form-control-range slider-input" type="range" id="disk-slider" name="disk"  step="100" min="100" max="2000" value="100">
										<span class="badge badge-primary output" style="font-size: 14px;"></span>
										<p class="text-muted">Additional disk size, excluding the default OS disk</p>
									</div>
								</div>
							</div>
						</div>

						<div class="row" style="margin-top: 1.0em">
							<div class="col-md-4">
								<h4>3. Choose Image<span class="required">*</span></h4>
								<div style="margin-left:1em">
									<select class="selectpicker-disabled" name="template" id="template">
										<option></option>
										{% for os in os_order -%}
										<option value="{{ os }}">{{ os_names[os] }}</option>
										{%- endfor %}
									</select>
								</div>
							</div>
							<div class="col-md-4">
								<h4>4. Choose Network<span class="required">*</span></h4>
								<div style="margin-left:1em">
									<select class="selectpicker-disabled" name="network" id="network">
										<option></option>
										{% for network in networks_order -%}
										<option value="{{ network }}">{{ network_names[network] }}</option>
										{%- endfor %}
									</select>
								</div>
							</div>
							<div class="col-md-4">
								<h4>5. Choose Location Cluster<span class="required">*</span></h4>
								<div style="margin-left:1em">
									<select class="selectpicker-disabled" name="cluster" id="cluster">
										<option></option>
										{% for cluster in clusters -%}
										<option value="{{ cluster.name }}"{% if default_cluster == cluster.name %} selected="selected"{% endif %}>{{cluster.name}}</option>
										{%- endfor %}
									</select>
								</div>
							</div>
						</div>
						<div class="row" style="margin-top: 2em;">
							<div class="col-md-4">
								<h4>6. Infoblox Host Alias (optional)</h4>
								<div style="margin-left: 1em">
									<div class="form-group">
										<input class="form-control" id="dns_aliases" name="dns_aliases" placeholder="servicename.soton.ac.uk"/>
									</div>
								</div>
							</div>
							<div class="col-md-4">
								<h4>7. VMware Folder (optional)</h4>
								<div style="margin-left: 1em">
									<div class="form-group">
										<select class="selectpicker-disabled" name="vm_folder_moid" id="vm_folder_moid" data-live-search="true">
											<option></option>
											{% for folder in folders -%}
											<option value="{{ folder['id'] }}">{{ folder['fully_qualified_path'] }}</option>
											{%- endfor %}
										</select>
									</div>
								</div>
							</div>
							<div class="col-md-4">
								<h4>8. Summary</h4>
								<div style="margin-left: 1em">
									<p>A VM will be created with the following specifications.</p>
									<div style="font-size: 120%">
										<div><strong>vCPUs:</strong> <span id="val_vcpus">0</span></div>
										<div><strong>RAM:</strong> <span id="val_ram">0</span> GiB</div>
										<div><strong>Disk:</strong> <span id="val_disk">0</span> GiB</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="vm-description" class="tab-pane container fade">
                                                <h3>General VM recipe description</h3>
                                                <textarea class="form-control" id="vm_description" name="vm_description" placeholder="A general description for a VM recipe"></textarea>
                                        </div>
				</div>
		
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary save-vm-recipe-changes" data-dismiss="modal"><i class="fa fa-save" aria-hidden="true" style="margin-right: 0.2rem;"></i>Save Changes</button>
				</div>
			</div>
		</div>
	</div>
</div>
<!--
	Whenever a new VM gets added to the form, on of these cards is cloned, edited and added to the carousel

	Elements which get edited:
	* id (vm name)
	* data-target (the modal id)
	* the header (vm name)
	* the body (description)
-->
<div class="card d-none vm-card h-100" id="vm-card" style="margin: 0.4rem; width: 30%" data-toggle="modal" data-target="#">
	<div class="card-header">
			<input type="hidden" name="vm_recipe_name[]" value="" />
			<h4 class="float-left" style="margin-top: 4px; margin-bottom: 4px; overflow: hidden; white-space: nowrap; width: 100%; text-overflow: ellipsis;"></h4>
	</div>
	<div class="card-body" style="height: 90px; overflow-y: auto;">
		<p>Some general description</p>
	</div>
</div>

{%- if autocomplete_users %}
<datalist id="autocompleteUsers">
{%- for user in autocomplete_users %}
        <option>{{user.username}}</option>
{% endfor -%}
</datalist>
{% endif -%}

<!--
	Context menu which shows up when you right-click one of the VM recipe cards
-->
<div id="context-menu">
	<ul class="context-menu-items">
		<li class="context-menu-item">
			<a id="settings" class="context-menu-link" href="#" data-toggle="modal" data-target=""><i class="fa fa-cogs"></i>Settings</a>
		</li>
		<li class="context-menu-item">
			<a id="delete" class="context-menu-link" href="#" data-toggle="modal" data-target="#confirm-delete-vm-modal"><i class="fa fa-trash"></i>Delete</a>
		</li>
		<li class="context-menu-item">
                        <a id="clone" class="context-menu-link" href="#" data-toggle="modal" data-target="#vm-clone-modal"><i class="fa fa-clone"></i>Clone</a>
                </li>
	</ul>
</div>

<!--
	Since you cannot use the same VM recipe twice, you can clone a VM recipe,
	but you need to rename it and allocate it a new ID
-->
<div class="modal fade" id="vm-clone-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                                <h5 class="modal-title">Clone a VM recipe</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                </button>
                        </div>
                        <div class="modal-body">
				<div class="row">
					<div class="col-sm-4">
						<p style="text-align: center;">Give a new name to the recipe clone:</p>
					</div>
					<div class="col-sm-7">
						<input id="vm-clone-name" type="text" class="form-control" name="recipe_clone_name" placeholder="Type in a new name for the clone"></input>
					</div>
				</div>
                        </div>
                        <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button id="confirm-clone-vm" type="button" class="btn btn-success" data-dismiss="modal">Confirm</button>
                        </div>
                </div>
        </div>
</div>

<script type="text/javascript">
/****************************************************************
* HELPER FUNCTIONS
*****************************************************************/

// Helper function which determines if a service recipe already exists
function service_recipe_exists(recipe_name){
	var service_recipes_list = $("#autocomplete-service-templates option").map(function(){
		return $(this).attr('id');
	}).toArray();
	
	return service_recipes_list.includes(recipe_name);
}

// Helper function which determines if a VM recipe already exists
function vm_recipe_exists(recipe_name){
	var vm_recipes_list = $("#vms-card-list .card").map(function(){
		return $(this).attr('id');
	}).toArray();
	
	return vm_recipes_list.includes(recipe_name);
}

function input_name_exists(input_name){
	var input_names_list = $('[name]').map(function(){
		return $(this).attr('name');
	}).toArray();
	
	return input_names_list.includes(input_name);
}

// Returns a value or evaluates a function passed as an argument
function valOrFunction(val, ctx, args) {
	if (typeof val == "function") {
		return val.apply(ctx, args);
	} else {
		return val;
	}
}

// This helper just forces the form submission if the form is invalid 
// in order to trigger the html built in popovers for invalid forms
function invalid_input_helper(target_jQuery_selector, options){

	// get the DOM element of the target
	var target_DOM = $(target_jQuery_selector)[0];
	
	target_DOM.setCustomValidity(valOrFunction(options.defaultText, window, [target_DOM]));

	if(target_DOM.value == ""){
		target_DOM.setCustomValidity(valOrFunction(options.emptyText, window, [target_DOM]));
	} else {
		
		old_pattern = $(target_jQuery_selector).attr('pattern');
			
		// Set a custom pattern for the input validity (a pattern attribute will accept a regex)
		$(target_jQuery_selector).attr('pattern', options.pattern);
		
		// Set a custom message to be displayed when the pattern is not matched
		target_DOM.setCustomValidity(valOrFunction(options.invalidText, window, [target_DOM]));	
		
		// Check validity and trigger an invalid event if the input is not valid
		if(!target_DOM.checkValidity()){
			$("#service_request_form").find(":submit").click();
		}
		
		// Reset the pattern to nothing
		$(target_jQuery_selector).attr('pattern', old_pattern ? old_pattern : null);
	}
	
	// This deactivates the custom
	// Needs to be executed only once after the first input event if fired 
	$(target_jQuery_selector).one('input', function(){
		target_DOM.setCustomValidity("");
	});
}

function generate_carousel_indicators(form_steps, action){
	
	// Checks how many new slides need to be generated
	form_steps = form_steps + ($('#create-service-template-form > div').appendTo('.carousel-inner')).length;
	
	// Add the necessary number of carousel indicators
	for(var i=1; i<form_steps; i++){
		$('<li data-target="#vm-carousel" data-slide-to="'+(i)+'"></li>').appendTo('.carousel-indicators');
	}
	
	// hide some fields, change button text
	if(action == 'create_recipe'){
		$(".hide-on-create").toggleClass("d-none");
		$('.hide-on-create').find('[name]').prop('required', false);
		$('#submit_service_request').html("Save Recipe");
	}
	
}

function load_recipe_on_screen(template_data){

	// For each VM recipe, trigger a click event which will generate the cards on the final slide
	Object.keys(template_data['vms_recipes']).forEach(function(key, index){
		$("#new-vm-recipe").trigger("click", [template_data['vms_recipes'][key], key]);
	});
	
	// Set the value of the input which contains the service name
	$("#vm-carousel #service_name").attr('value', template_data['name']);

	// If the recipe contains an expiry date, then destroy the old
	// datetime picker and create a new one with the current expiry_date
	if('expiry_date' in template_data){
		$('#expirypicker').datetimepicker('destroy');
		$('#expirypicker').datetimepicker({
						viewMode: 'days',
						format: 'YYYY-MM-DD',
						minDate: moment(),
						useCurrent: false,
						widgetPositioning: {
							horizontal: 'right',
							vertical: 'top',
						},
						date: new Date(template_data['expiry_date']),
		});
	}
	
	// Enable, update and refresh the selectpicker on the 2nd slide
	$("#env").removeClass("selectpicker-disabled").addClass("selectpicker");
	$("#env").val(template_data['env']);
	$("#env").selectpicker('refresh');
	
	// Set the value of the email notification input
	$("#vm-carousel #sendmail").prop('checked', template_data['email_notification'] == "on" ? true : false);

	// Load the additional questions if they exist
	var questions = (template_data['questions']) ? JSON.parse(template_data['questions']) : null;
	
	// for each additional question. trigger a click event to load it on screen
	if(questions){
		$.each(questions, function(key, value){
			var question_reference = key
			var question_data = questions[question_reference];

			question_data['question_reference'] = question_reference

			$('#submit-question').trigger('click', [question_data]);
		});
	}
}

// The target has to be a jquery object (like $('#some_id'))
function config_context_menu(target){
	
	// add context menu event listener
	target.contextmenu(function(event){
	
		// prevent the browser context menu from popping up
		event.preventDefault();
	
		
		// if the context menu was already displayed somewhere else, hide it
		$('#context-menu').css({"display": "none"});
	
		// respawn the context menu at the event location
		check_spawn(event, '#context-menu');
		
		// Extract the VM recipe name
		var name = target.attr('id'); 
		
		// set the target modal to the one corresponding to this VM
		$("#context-menu #settings").attr('data-target', "#"+name+"-modal");
		
		// add the name to the current target attribute (used by the menu options which do not trigger modals)
		$("#context-menu").attr("data-current-card", name);
		
		// Add the VM recipe name in bold inside the modal
		$("#confirm-delete-vm-modal .modal-body").find("h5").eq(0).html("Are you sure you want to delete the '<div style=\"font-weight: bold; display:inline;\">"+name+"</div>' recipe?");
	
		// unbind old events as they are not relevant anymore	
		$('#confirm-delete-vm').unbind('click');
		
		// This modal is used for all the VM recipes, so the
		// event listener should be a one-time thing since the definition changes slightly for each VM recipe
		$("#confirm-delete-vm").one('click', function(){
		
			// Send ajax POST request in order to remove the VM recipe from the database
			$.ajax({
				type: "POST",
				async: true,
				global: false,
				url: '{{url_for("delete_vm_recipe")}}',
				dataType: "json",
				data: JSON.stringify({"vm_recipe_name": name}),
				contentType: "application/json; charset=utf-8",
				success: function(){
					jsFlash("Successfully deleted the "+name+" VM recipe.", "success", true);
				},
				failure: function(){
					jsFlash("An error has occured while attempting to delete the "+name+" VM recipe!", "danger", true);
				},
			});	
			
			// if this recipe existed before, add it back to the datalist
			var row = target.closest(".row");
			
			if(row.find(".card").length == 1){
				row.remove();
			} else {
				$("#"+name).remove();
			}
		
			// Destroy the modal if it exists
			var modal = $("#" + name + "-modal");
			if(modal.length){
				modal.remove();
			}
		});
	});
}

// This function makes the context menu spawn at the event position
function check_spawn(event, target_jq_selector){
	
	// document data
	var doc_h = $(document).height();
	var doc_w = $(document).width();

	// context menu data
	var elem_h = $(target_jq_selector).height();
	var elem_w = $(target_jq_selector).width();

	// event data
	var position = get_position(event);

	// these if/else statements just ensure that the context menu spawns on the right side
	// of the cursor so it doesn't overflow from the document (basically, ensure that the whole menu is visible)
	if( position['x'] + elem_w > doc_w){
		 $(target_jq_selector).css({'display': 'block', 'position':'absolute','left': (position['x'] - elem_w),'top': position['y']});
	} else if((position['x'] + elem_w > doc_w) && (position['y'] + elem_h > doc_h)){
		 $(target_jq_selector).css({'display': 'block', 'position':'absolute','left': (position['x'] - elem_w),'top': (position['y'] - elem_h)});
	} else if(position['y'] + elem_h > doc_h){
		 $(target_jq_selector).css({'display': 'block', 'position':'absolute','left': position['x'],'top': (position['y'] - elem_h)});
	} else {
		$(target_jq_selector).css({'display': 'block', 'position':'absolute','left': position['x'],'top': position['y']});
	}

}

// Helper which returns coordinates of an event
function get_position(e) {

	var posx = 0;
	var posy = 0;

	if (!e) var e = window.event;
	
	if (e.pageX || e.pageY) {
		posx = e.pageX;
		posy = e.pageY;
	} else if (e.clientX || e.clientY) {
		posx = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
		posy = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
	}

	return {
		x: posx,
		y: posy
	}

}

// Helper which returns specific parts of the form
function collect_questions() {
	
	var questions_data = $('#current-additional-questions input');
	var service_data = $('#service_name')[0];
	questions_data.push(service_data);

	return questions_data.serialize();
}

/*************************************************
* EVENT LISTENERS
**************************************************/

$(document).ready(function(){
	
	// On click hide the context menu
	$(document).click(function(){
		$('#context-menu').css({"display": "none"});
	});

	// Hide the context menu whenever the user clicks on anything that's
	// not a card
	$(document).contextmenu(function(event){
		if(!$(event.target).parents(".card").length) $('#context-menu').css({"display": "none"});
	});

	// This event listener makes it possible to stack bootstrap modals
	$(document).on('show.bs.modal', '.modal', function () {
		// increase the default z-index for the new modal
		var zIndex = 1040 + (10 * $('.modal:visible').length);
		$(this).css('z-index', zIndex);
		setTimeout(function() {
			$('.modal-backdrop').not('.modal-stack').css('z-index', zIndex - 1).addClass('modal-stack');
		}, 0);
	});

	
	// Set up datatable
	var systemsTable = $('#service-recipes-table').DataTable({
		"lengthMenu": [[10,15,50,100,-1], [10,15,50,100,'All']],
		"pageLength": 15,
		"order": [[0, 'desc']],
		"columns": [
			{"data": "name"},
			{"data": "description"},
			{"data": "default_environment"},
			{"data": "actions", "orderable": false},
		],
		"language": {"emptyTable":"No service recipes available at the moment."},
		"searching": true,
	});
	
	var form_steps = 1;
	
	$('#question-name-value').on('input', function(event) {
		$("#question-name-value")[0].setCustomValidity("");
		event.target.checkValidity();
	}).on('invalid', function(event) {

		$("#service_request_form").find(":submit").click();
		$("#question-name-value")[0].setCustomValidity("Please only use letters, digits and underscores.");
	});

	$("#submit-question").click(function(event, question_data){
		
		if(!question_data && $("#question-name-value")[0].validity.valid){

			// Extract the input values
			var text = question_data ? question_data['text'] : $('#question-text-input').val();
			var answer = question_data ? question_data['answer'] : $('#question-answer').val();
			var name_value = question_data ? question_data['question_reference'] : $('#question-name-value').val();

			if(text && name_value && !input_name_exists(name_value)){
				
				// clone the template
				var question_row = $(".question-row").clone();
				
				// remove the display:none class
				question_row.removeClass("d-none");
				question_row.removeClass("question-row");
				
				// edit inner HTML and attributes
				question_row.attr("id", name_value);
				question_row.find(".question-text").eq(0).html(text);
				question_row.find(".answer-input").eq(0).val(answer);
				question_row.find(".answer-input").eq(0).attr('name', 'questions['+name_value+'][answer]');
				question_row.find("[name=text]").eq(0).val(text);
				question_row.find("[name=text]").eq(0).attr('name', 'questions['+name_value+'][text]');

				// add an event listener to the delete button
				question_row.find(".delete-question").eq(0).click(function(){
					// All questions use the same modal for confirmation
					// so unbind any previously bound click event listeners
					$("#confirm-delete-question-modal #confirm").unbind('click');
					$("#confirm-delete-question-modal #confirm").click(function(){
						$("#" + name_value).remove();

						// If in edit mode, run ajax to asynchronously remove the quesiton from the database
						if($("#action").val()=="use_recipe"){
							$('#save-questions-changes').trigger('click', ["Successfully deleted the question with the reference: '"+name_value+"'."]);
						} else {
							jsFlash("Successfully deleted the question with the reference: '"+name_value+"'.", "success", true);
						}
					});
				});
				
				// add event listener for the info modal (all questions will use the same modal)
				// the modal's inner HTML gets changed on click
				question_row.find(".question-info").eq(0).click(function(){
					$("#question-info-modal").find(".full-text-info").html("<p class='font-weight-bold'>\{\{questions."+name_value+".text\}\}:</p>" + text);
					$("#question-info-modal").find(".answer-info").html("<p class='font-weight-bold'>\{\{questions."+name_value+".answer\}\}:</p>" + answer);
				});

				// Append the new question to the modal
				$('#current-additional-questions .modal-body').append(question_row);
				
				// Refresh the input values
				$('#question-text-input').val("");
				$('#question-answer').val("");
				$('#question-name-value').val("");
				
				// If the event is triggered from an actual click in edit mode
				// trigger AJAX and save the changes asynchronously
				if($('#action').val() == 'use_recipe' && !question_data) $('#save-questions-changes').trigger('click');
				
				$('#add-form-question').modal('toggle');
			}
		}
	});
	
	$("#save-questions-changes").click(function(e, success_message, failure_message){
		// Only run AJAX when in edit mode. When creating a recipe everything will be
		// saved on submission
		if($('#action').val() == "use_recipe"){
			$.ajax({
				type: "POST",
				async: true,
				global: false,
				url: '{{url_for("update_questions")}}',
				data: collect_questions(), // collect the DOM elements of the inputs which need to be submitted
				dataType: "json",
				success: function(){
					jsFlash(success_message ? success_message : "Successfully saved your changes.", "success", true);
				},
				failure: function(){
					jsFlash(failure_message ? failure_message : "Something went wrong!", "danger", true);
				},
			});
		} else {
			jsFlash("Your changes will be saved on recipe submission as you are in the creation mode now.", "info", true);
		}

	});
	
	$("#confirm-clone-vm").click(function(){
		// extract the name of the VM which should be cloned
		var name = $('#context-menu').attr('data-current-card');
		
		var new_name = $("#vm-clone-name").val();
		
		if(new_name && !vm_recipe_exists(new_name)){

			// a jQuery clone() does not preserve the value of the selectpickers for some reason
			var clone = $("#"+name+"-modal");
			
			// The solution is to extract all the data from the original modal and to create
			// a new VM recipe with the collected data
			var recipe_data = {}
			recipe_data['puppet_code'] = clone.find("[name=service_vms\\["+name+"\\]\\[puppet_classes\\]]").eq(0).val();
			recipe_data['purpose'] = clone.find("[name=service_vms\\["+name+"\\]\\[purpose\\]]").eq(0).val();
			recipe_data['comments'] = clone.find("[name=service_vms\\["+name+"\\]\\[comments\\]]").eq(0).val();
			recipe_data['primary_owner_who'] = clone.find("[name=service_vms\\["+name+"\\]\\[primary_owner_who\\]]").eq(0).val();
			recipe_data['primary_owner_role'] = clone.find("[name=service_vms\\["+name+"\\]\\[primary_owner_role\\]]").eq(0).val();
			recipe_data['secondary_owner_who'] = clone.find("[name=service_vms\\["+name+"\\]\\[secondary_owner_who\\]]").eq(0).val();
			recipe_data['secondary_owner_role'] = clone.find("[name=service_vms\\["+name+"\\]\\[secondary_owner_role\\]]").eq(0).val();
			recipe_data['sockets'] = clone.find("[name=service_vms\\["+name+"\\]\\[sockets\\]]").eq(0).val();
			recipe_data['cores'] = clone.find("[name=service_vms\\["+name+"\\]\\[cores\\]]").eq(0).val();
			recipe_data['ram'] = clone.find("[name=service_vms\\["+name+"\\]\\[ram\\]]").eq(0).val();
			recipe_data['disk'] = clone.find("[name=service_vms\\["+name+"\\]\\[disk\\]]").eq(0).val();
			recipe_data['os'] = clone.find("[name=service_vms\\["+name+"\\]\\[template\\]]").eq(0).val();
			recipe_data['network'] = clone.find("[name=service_vms\\["+name+"\\]\\[network\\]]").eq(0).val();
			recipe_data['location_cluster'] = clone.find("[name=service_vms\\["+name+"\\]\\[cluster\\]]").eq(0).val();
			recipe_data['dns_aliases'] = clone.find("[name=service_vms\\["+name+"\\]\\[dns_aliases\\]]").eq(0).val();
			recipe_data['vm_folder_moid'] = clone.find("[name=service_vms\\["+name+"\\]\\[vm_folder_moid\\]]").eq(0).val();
			recipe_data['description'] = clone.find("[name=service_vms\\["+name+"\\]\\[vm_description\\]]").eq(0).val();

			
			$("#new-vm-recipe").trigger("click", [recipe_data, new_name, true]);

			$("#vm-clone-name").val("");
			
			jsFlash("VM recipe successfully cloned.", "success", true);
			
		} else {
			jsFlash("The name you chose already exists or is invalid!", "danger", true);
		}
	});

	$(".delete-service").click(function(){
		var rec_name = $(this).attr('data-name');
		dataTable_row = $(this).closest("tr");
		var table = $("#service-recipes-table").DataTable();
		
		$("#confirm-delete-modal .modal-body").find("h5").eq(0).html("Are you sure you want to delete the '<div style=\"font-weight: bold; display:inline;\">"+rec_name+"</div>' recipe?");
		
		// all the .delete-service buttons use the same modal for confirmation
		// so unbind any previously bound click events from other buttons
		$("#confirm-delete-modal #confirm").unbind('click');

		// use AJAX and remove the row from the datatable on success
		$("#confirm-delete-modal #confirm").one('click', function(){
			$.ajax({
				type: "POST",
				async: true,
				global: false,
				url: '{{url_for("delete_service_recipe")}}',
				data: $.param({"service_recipe_name": rec_name}),
				dataType: "json",
				success: function(data){
					jsFlash("Successfully deleted the "+rec_name+" service recipe.", "success", true);
					table.row(dataTable_row).remove().draw();
				},
				failure: function(){
					jsFlash("Failed to delete the "+rec_name+" service recipe!", "danger", true);
				},
			});

		});
	});
	
	$("#create-service-template").click(function (e, template_data){
		var action = template_data ? 'use_recipe' : 'create_recipe';

		$("#action").attr('value', action);
		
		// the ServiceNow ticket is only required when actually using the recipe
		if(action == 'create_recipe') $("[name=task]").attr('required', false);
		
		// generate the indicators
		generate_carousel_indicators(form_steps, action);
		
		// Basically, if the user is using an existing service recipe
		if(template_data) load_recipe_on_screen(template_data);
		
		else {
			// Enable, update and refresh the selectpicker on the 2nd slide
			$("#env").removeClass("selectpicker-disabled").addClass("selectpicker");
			$("#env").selectpicker();
		}
		
		// input autofocus does not work inside modals, so trigger it manually
		$("#add-form-question, #add-vm-existing-recipe, #vm-clone-modal").on('shown.bs.modal', function(){
			$('input:text:visible:first', this).focus();
		});
			
		// go to the next step
		$("#vm-carousel").carousel('next');
	});

	$(".submit-template-request").click(function(e){
		$("#action").attr('value', 'use_recipe');

		service_recipe_name = $(this).attr('data-name');
		
		// The fields like the service description don't need to be filled in on use/edit
		$(".hide-on-use").toggleClass("d-none");
		$('.hide-on-use').find('[name]').prop('required', false);
		
		$.ajax({
			type: "POST",
			async: true,
			global: false,
			url: '{{url_for("get_service_recipe")}}',
			data: JSON.stringify({"service_recipe_name": service_recipe_name}),
			contentType: "application/json; charset=utf-8",
			dataType: "json",
			success: function(recipe_data){
				jsFlash("Successfully loaded the " +service_recipe_name+ " service recipe.", "success", true);
				$("#add-service-existing-template").modal('hide');
		                $("#create-service-template").trigger("click", [recipe_data]);
			},
			failure: function(error_message){
				jsFlash("The " +service_recipe_name+ " recipe does not exist. You can create it now.", "info", true);
				$("#add-service-existing-template").modal('hide');
				$("#create-service-template").trigger("click");
			},
		});
	});

	// Add event listener on carousel slide
	$('#vm-carousel').on('slide.bs.carousel', function (e, stuff) {
		
		// do not allow the user to go back once they've chosen an action
		if(e.from == 1 && e.direction == "right"){
			e.preventDefault();
		}
		
		if(e.from == 1 && e.direction == "left"){

			// collect data about the current values of the input fields on the current slide
			var current_slide = $(this).find('.carousel-item.active');
			var current_service_name = $(current_slide).find("input[name=service_name]").eq(0).val();
			var current_service_description = $(current_slide).find("textarea[name=service_description]").eq(0).val();
			var current_service_env = $(current_slide).find("select[name=env]").eq(0).val();
			var service_now_task = $(current_slide).find("input[name=task]").eq(0).val();
			var action_type = $("input[name=action]").val();
			
			// add an event listener to check if the user is trying to use an existing service name
			if(current_service_name && action_type == "create_recipe" && service_recipe_exists($("#service_name").val())){
				
				// prevent the carousel from going to the next slide
				e.preventDefault();

				// customize the popover message
				invalid_input_helper("#service_name", {
					defaultText: "Please fill in this field!",
					emptyText: "Please fill in this field!",
					invalidText:"This service recipe name already exists!",
					pattern: "^(?!"+$("#service_name").val()+").*$",
				});

			} else if(!current_service_name || (!current_service_description && action_type == "create_recipe") || !current_service_env || (!service_now_task && action_type=="use_recipe")){
				// prevents the carousel from going to the next slide
                                e.preventDefault();
                                
                                // manually attempt form submission if the validity is false
				if(!$("#service_request_form")[0].checkValidity()){
					$("#service_request_form").find(":submit").click();
				}

			} else {
				// else everything's fine, go to the next slide
                                $(this).trigger('slide.bs.carousel');
			}
		}
	});
	
	$('#vm-recipe-input').on('input', function(e){
		e.target.checkValidity();
		$(this)[0].setCustomValidity("");
	}).on('invalid', function(){
		$("#service_request_form").find(":submit").click();
		$(this)[0].setCustomValidity("Please only use letter, digits or underscores.");
	});

	$("#new-vm-recipe").click(function(e, recipe_data, recipe_name, is_clone_or_new){
		// extract the recipe name from the input
		var vm_recipe_name = recipe_name ? recipe_name : $("#vm-recipe-input").val();

		// The vm_recipe_name has to contain word characters only
		if(/\w+/.test(vm_recipe_name)){

			// If the VM recipe is not already on screen
			if(!vm_recipe_exists(vm_recipe_name)){
				// If the the event was triggered with no data about the recipe (it is a new recipe)
				// Try to fetch data about it from the server or just create a blank one if failed
				if(!recipe_data && !recipe_name && vm_recipe_name){
					
					$.ajax({
						type: "POST",
						async: true,
						global: false,
						url: '{{url_for("get_vm_recipe")}}',
						data: JSON.stringify({"vm_recipe_name": vm_recipe_name}),
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function(vm_recipe_data){
							$("#add-service-existing-template").modal('hide');
							$("#new-vm-recipe").trigger("click", [vm_recipe_data, vm_recipe_name]);
						},
						failure: function(error_message){
							jsFlash("This VM recipe does not exist. You can define it now.", "info", true);
							$("#add-service-existing-template").modal('hide');
							$("#new-vm-recipe").trigger("click", [null, vm_recipe_name]);
						},
					});
				}
				
				else {
					
					if($(this).val()) $("#vm-recipe-input").val("");

					if(recipe_data){
						$("#service-now-task").removeClass("d-none");
					}
					var general_description = (recipe_data && recipe_data['description']) ? recipe_data['description'] : vm_recipe_name;
					
					var card = $("#vm-card").clone();
					card.toggleClass('d-none');
					card.attr('id', vm_recipe_name);
					card.attr('data-exists', recipe_name ? 'true' : 'false'); // since a VM recipe cannot be used twice, you need to know if it should be added back to the list once the card gets deleted
					card.attr('data-target', '#'+vm_recipe_name+'-modal');
					card.find(".card-header h4").eq(0).html(vm_recipe_name);
					card.find(".card-header input").eq(0).attr('value', vm_recipe_name);
					card.find(".card-body p").eq(0).html(general_description);
					/*
					*  This is how cards are added to the slide
					*  Need to come up with a function that does this instead.
					*/
					var number_of_cards = $(".vm-card").length -1;
					if(number_of_cards % 3 == 0){
						var row = $($.parseHTML('<div class="row col-md-12"></div>'));
						row.append(card);
						$("#vms-card-list").append(row);
					} else {
						$("#vms-card-list .row").last().append(card);
					}
					
					config_context_menu(card);
					
					if($("#"+vm_recipe_name+"-modal").length == 0){
						// clone the modal
						var modal = $("#vm-recipe-template-modal").clone();

						// manually initialize the selectpickers
						modal.find(".selectpicker-disabled").each(function(){
							$(this).addClass("selectpicker").removeClass("selectpicker-disabled");
							$(this).selectpicker();
						});
						
						// Change the clone's relevant IDs so they can be referenced later			
						modal.attr('id', vm_recipe_name+"-modal");
						modal.find(".modal-header h5").eq(0).html("Config "+ vm_recipe_name);
						modal.find(".modal-body textarea").eq(0).attr('id', vm_recipe_name+"-textarea");
						modal.find(".modal-body #vm-puppet").eq(0).attr('href', "#puppet-code-"+vm_recipe_name);
						modal.find(".modal-body #vm-configuration").eq(0).attr('href', "#config-"+vm_recipe_name);
						modal.find(".modal-body #vm-description-tab").eq(0).attr('href', '#vm-description-'+vm_recipe_name);
						modal.find(".modal-body #puppet-code").eq(0).attr('id', "puppet-code-"+vm_recipe_name);
						modal.find(".modal-body #config").eq(0).attr('id', "config-"+vm_recipe_name);
						modal.find(".modal-body #vm-description").eq(0).attr('id', "vm-description-"+vm_recipe_name);
						if(is_clone_or_new == true){
							modal.find(".modal-body").append("<input type=hidden name='is_clone_or_new' value='true'></input>");
						}

						// Apply existing configuration if it already exists
						if(recipe_data){
							modal.find(".modal-body #purpose").eq(0).attr('value', recipe_data['purpose']);
							modal.find(".modal-body #comments").eq(0).attr('value', recipe_data['comments']);
							modal.find(".modal-body #primary_owner_who").eq(0).attr('value', recipe_data['primary_owner_who']);
							modal.find(".modal-body #primary_owner_role").eq(0).attr('value', recipe_data['primary_owner_role']);
							modal.find(".modal-body #secondary_owner_who").eq(0).attr('value', recipe_data['secondary_owner_who']);
							modal.find(".modal-body #secondary_owner_role").eq(0).attr('value', recipe_data['secondary_owner_role']);
							modal.find(".modal-body #sockets-sldier").eq(0).attr('value', recipe_data['sockets']);
							modal.find(".modal-body #ram-slider").eq(0).attr('value', recipe_data['ram']);
							modal.find(".modal-body #disk-slider").eq(0).attr('value', recipe_data['disk']);
							modal.find(".modal-body #cores-slider").eq(0).attr('value', recipe_data['cores']);
							modal.find(".modal-body #template").eq(0).val(recipe_data['os']);
							modal.find(".modal-body #template").eq(0).selectpicker('refresh');
							modal.find(".modal-body #cluster").eq(0).val(recipe_data['location_cluster']);
							modal.find(".modal-body #cluster").eq(0).selectpicker('refresh');
							modal.find(".modal-body #network").eq(0).val(recipe_data['network']);
							modal.find(".modal-body #network").eq(0).selectpicker('refresh');
							modal.find(".modal-body #dns_aliases").eq(0).attr('value', recipe_data['dns_aliases'] ? recipe_data['dns_aliases'] : "");
							modal.find(".modal-body #vm_folder_moid").eq(0).val(recipe_data['vm_folder_moid']);
							modal.find(".modal-body #vm_folder_moid").eq(0).selectpicker('refresh');
							modal.find(".modal-body #vm_description").eq(0).val(general_description);
						}
					
						// Append the cloned modal's html to the carousel	
						$(".carousel-inner").append(modal);
						
						// Add event listeners for the existing recipes to update them
						// when the 'Save Changes' button is clicked
						if(card.attr('data-exists') == 'true'){
							modal.find(".save-vm-recipe-changes").eq(0).click(function(){
								if($("#action").val() == "use_recipe"){
									// get all the input fields values
									var form_data = $("#"+vm_recipe_name+"-modal [name]").map(function(){
												var val=$(this).val();
												var rec_name=$(this).attr('name');
												return {name: rec_name, value: val};
											});
									$.ajax({
										type: "POST",
										async: true,
										global: false,
										url: '{{url_for("update_vm_recipe")}}',
										data: $.param(form_data),
										dataType: "json",
										success: function(data){
											jsFlash("Successfully updated "+vm_recipe_name+".", "success", true);

										},
									});
								}
							});
						}
						
						// Set the input name attribute to contain the vm_recipe_name
						modal.find("input, textarea, .selectpicker").each(function(){
							$(this).attr('name', ("service_vms["+vm_recipe_name+"]"+"["+$(this).attr('name')+"]"));
						});
						
						// Link each slider to its label
						var sliders = $('#config-'+vm_recipe_name+" .slider-input");
						sliders.each(function(){
							$(this).parent().find(".output").eq(0).html($(this).val());
						});
						
						// Initial update for the summary
						$('#config-'+vm_recipe_name+' #val_vcpus').text($('#config-'+vm_recipe_name+" #sockets-slider").val() * $('#config-'+vm_recipe_name+" #cores-slider").val());
						$('#config-'+vm_recipe_name+' #val_ram').text($('#config-'+vm_recipe_name+" #ram-slider").val());
						$('#config-'+vm_recipe_name+' #val_disk').text($('#config-'+vm_recipe_name+" #disk-slider").val());
						
						// On input update the label value and the config summary
						sliders.on('input', function(event, value){
							$(this).parent().find(".output").eq(0).html($(this).val());
							$('#config-'+vm_recipe_name+' #val_vcpus').text($('#config-'+vm_recipe_name+" #sockets-slider").val() * $('#config-'+vm_recipe_name+" #cores-slider").val());
							$('#config-'+vm_recipe_name+' #val_ram').text($('#config-'+vm_recipe_name+" #ram-slider").val());
							$('#config-'+vm_recipe_name+' #val_disk').text($('#config-'+vm_recipe_name+" #disk-slider").val());
						});
						
						// Get and set the puppet code
						puppet_code = recipe_data ? recipe_data['puppet_code'] : '';
						$("#"+vm_recipe_name+'-textarea').html(puppet_code);

						// On 'show modal', set up CodeMirror
						modal.on('shown.bs.modal', function (e) {
							var delete_button = e.relatedTarget;
							
							// Prevent the delete button from triggering the 'show modal' event
							if($(delete_button).hasClass('no-modal')) {
								e.stopPropagation();
							}  

							// If CodeMirror hasn't already been initialized
							if($(this).find(".CodeMirror").length == 0){
								var classes_editor = CodeMirror.fromTextArea(document.getElementById(vm_recipe_name+'-textarea'), 
								{
									mode: 'yaml',
									gutters: ["CodeMirror-lint-markers"],
									lint: true,
									indentUnit: 2,
									viewportMargin: Infinity,
								});
								
								// Set editor size
								classes_editor.setSize(1100,500);
								// Update the textarea
								classes_editor.on('change', function(){
									classes_editor.save();
								});
							}
						});

					}

					// Ensure the modal is hidden
					$("#add-vm-existing-recipe").modal('hide');
				}
				// reset the input field's value
				$("#vm-recipe-input").val("");
			} else {
				$("#add-vm-existing-recipe").modal('hide');
				$("#vm-recipe-input").val("");
				jsFlash("This VM recipe already exists!", "danger", true);
			}
		} else {
			$("#vm-recipe-input").val("");
			jsFlash("The name you've chosen contains illegal characters. Please use only letters, numbers and underscores.", "danger", true);
		}
	});
	
	// Sandbox/Standard toggle button event listener
	$('.btn-toggle').click(function(e) {
		e.preventDefault(); // prevents the form submission
		$(this).find('.btn').toggleClass('active');
		if ($(this).find('.btn-primary').size()>0) {
			$(this).find('.btn').toggleClass('btn-primary');
		}
		$(this).find('.btn').toggleClass('btn-secondary');

		// update the input to be sandbox or standard
		$("#workflow_type").val($(this).find(".active").attr("data-value"));
	});
	
	// Cannot submit a service recipe that doesn't contain
	// at least a VM recipe
	$("#service_request_form").submit(function(e){
		if(!$(this).find(".card").length){
			e.preventDefault();
			jsFlash("Your service recipe has to contain at least one VM recipe!", "danger", true);
		}
	});
});

</script>
{% endblock %}
