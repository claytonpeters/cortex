{% extends "layout.html" %}
{% block head %}
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/vendor/bootstrap-select.min.css') }}">
	<script type="text/javascript" src="{{ url_for('static', filename='js/vendor/bootstrap-select.min.js') }}"></script>


	{% include 'puppet/codemirror.html' %}
{% endblock %}

{% block body %}
{% import 'node-header.html' as node %}
{% import 'puppet/header.html' as puppeth %}
{{ node.header(system,active="dsc" ) }}

<style type="text/css">

.bootstrap-select .bs-ok-default::after {
	width: 10em;
	height: 10em;
	border-width: 0 0.1em 0.1em 0;
	transform: rotate(45deg) translateY(0.5rem);
}

.btn.dropdown-toggle:focus {
	outline: none !important;
}


.btn dropdown-toggle {
	min-width: 100em !important;
}
</style>

<script>
$(document).ready(function() 
{
	var classes_editor = CodeMirror.fromTextArea(document.getElementById('configurations'), 
	{
		mode: 'yaml',
		gutters: ["CodeMirror-lint-markers"],
		lint: true,
		indentUnit: 2,
		viewportMargin: Infinity,
	});

	classes_editor.setOption("extraKeys", 
	{
		Tab: function(cm) {
			var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
			cm.replaceSelection(spaces);
		}
	});

});
</script>

<form class="form-horizontal" method="POST" role="form" id="dsc_form">
<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
	<div class="panel panel-default">
		<div class="panel-heading">DSC Roles
			<div class="pull-right">
				<button class="btn btn-danger btn-xs" type="submit" id="return_to_default" value="return_to_default" name="button">Reset</button>
			</div>
		</div>
		<div class="panel-body" style="padding-bottom:0em">
			<div class="form-group">
				<label title="The roles that this box fulfils" class="col-xs-1 control-label">Roles:</label>
				<div class="col-lg-15">
					<select multiple data-style="bg-white rounded-pill px-40 py-3 shadow-sm" class="selectpicker w-100" id="roles" name="roles" data-width="85%"> 
						{% for role in roles %}
							{% if role != 'AllNodes' %}
								<option value="{{ role }}" {% if role == "Generic" %} selected="selected" {% endif %}>{{ role }}</option>
							{% endif %}
						{% endfor %}
					</select>
					<button class="btn btn-success btn-sm btn-default hidden"  style="padding-left: 10px">Add</button>
					<button class="btn btn-danger btn-sm btn-default hidden" style="padding-left: 10px">Remove</button>
				</div>
			</div>
			<input type="hidden" id="selected_values" name="selected_values">
		</div>
	</div>

<div class="panel-group" id="accordion">
	{% for role in set_roles %}
		{% if role != 'AllNodes'%}
			<div class="panel panel-default">
				<div class="panel-heading">
					<h4 class="panel-title">
						<a class="role-parent" data-toggle="collapse" data-parent="#accordion" data-role="{{ role }}" href="#{{ role }}"> {{ role }} </a>
						<div class="pull-right">
							<button class="btn btn-default btn-xs" type="button" id="select_all" value="select_all" name="button" onclick="checkAll( {{role}} )">Select All</button>
							<button class="btn btn-default btn-xs" type="button" id="deselect_all" value="deselect_all" name="button" onclick="uncheckAll( {{role}} )">Deselect All</button>
						</div>
					</h4>
				</div>

				<div id="{{ role }}" class="panel-collapse collapse">
					<div class="panel-body">	
						{% for config in role_info[role] %}
							<div class="checkbox">
								<label><input class="chkboxes" type="checkbox" value="{{ config['Name'] }}{{ config['GroupName'] }}{{ config['TaskName'] }}" {% if config['Name'] in set_roles[role].values() or config['GroupName'] in set_roles[role].values() or config['TaskName'] in set_roles[role].values() %} checked {% endif %} role="{{ role }}">{{ config['Name'] }}{{ config['GroupName'] }}{{ config['TaskName'] }}</label>
							</div>
						{% endfor %}
					  </div>
				</div>
			</div>
		{% endif %}
	{% endfor %}
</div> 

<div class="row" id="element">
	<div class="panel panel-default">
		<div class="panel-heading" >DSC Configurations 
			<div class="pull-right">
				<button class="btn btn-success btn-xs" type="submit" id="reset" value="reset" name="button">Save and Reset</button>
				<button class="btn btn-light btn-xs" type="button" id="show_yaml" value="show_yaml" name="button">Show</button>
				<button class="btn btn-light btn-xs" type="button" id="hide_yaml" value="hide_yaml" name="button">Hide</button>
			</div>
		</div>
		<div class="panel-body" style="padding:0px" id='yaml_display'>
			<textarea id="configurations" name="configurations" placholder="Configurations to include can be entered here">{{ yaml }}</textarea>
		</div>
	</div>
	<div class="text-center">
		<button class="btn btn-primary btn-lg" type="submit" id="save_changes" value="save_changes" name="button" style="padding-right: 15px">Save and Generate</button>
		<button class="btn btn-success btn-lg" type="submit" id="push_to_dsc" value="push_to_dsc" name="button">Push to Box</button>
	</div>	
</div>
<input type="hidden" name="checked_values" id="checked_values" value="">
</form>

<script type="text/javascript">

window.onload = function() {
	var exist_roles = Object.keys({{ selectpicker_tick|tojson }});
	
	$('.selectpicker').selectpicker('val', {{ selectpicker_tick|tojson }});

};

function checkAll(r){
	$("input[role=\""+r['id']+"\"]").prop("checked", true);
}

function uncheckAll(r){
	$("input[role=\""+r['id']+"\"]").prop('checked', false);
}


$("#save_changes").click(function(e){
	$("#selected_values").val($('.selectpicker').selectpicker('val'));
	var json = {}
	$(".role-parent").each(function(){
			var role = $(this).attr('data-role');
			var checked = $(this).closest(".panel").find(".chkboxes:checkbox:checked").map(function(i,elem){return $(this).val()});
			json[role] = checked;
	});
	$("#checked_values").val(JSON.stringify(json));


	$("#dsc_form").submit();
});

$('#reset').click(function(argument) {
	$("#selected_values").val($('.selectpicker').selectpicker('val'));
	var json = {}
	$(".role-parent").each(function(){
			var role = $(this).attr('data-role');
			var checked = $(this).closest(".panel").find(".chkboxes:checkbox:checked").map(function(i,elem){return $(this).val()});
			json[role] = checked;
	});
	$("#checked_values").val(JSON.stringify(json));


	$("#dsc_form").submit();
});

$("#reset").click(function(){
	$("#selected_values").val($('.selectpicker').selectpicker('val'));
	$("#dsc_form").submit();
});
$(document).ready(function() {
	$("#yaml_display").hide();
	
	$("#hide_yaml").click(function(){
		$("#yaml_display").hide();
	});
	$("#show_yaml").click(function(){
		$("#yaml_display").show();
	});
});

</script>




{% endblock %}
